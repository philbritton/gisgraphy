<html>
<head>
<title>Gisgraphy-leaflet plugin</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
 <LINK href="style/gisgraphy-leaflet.css" rel="stylesheet" type="text/css">
</head>
<body>
<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="js/placetype.js"></script>
<script src="js/typeahead/jquery-1.11.1.js"></script>
<script src="js/typeahead/typeahead.bundle.js"></script>
<script src="js/typeahead/bloodhound.js"></script>
<script src="js/typeahead/typeahead.jquery.js"></script>
<script src="js/typeahead/handlebars-v1.3.0.js"></script>

<div id="gisgraphy-leaflet">
<form id="gisgraphy-leaflet-form">
</form>
</div>

<script type="text/javascript">
ELEMENT_ID="gisgraphy-leaflet";
DEFAULT_LANGUAGE="EN";
currentLanguage=DEFAULT_LANGUAGE;
allowPoiSelection=true;
allowLanguageSelection=true;
formNodeID=ELEMENT_ID+'-form';
placetypeNodeID=ELEMENT_ID+'-placetypes';
languagesNodeID=ELEMENT_ID+'-languages';
inputSearchNodeID=ELEMENT_ID+'-inputSearch';
fulltextURL='http://localhost:8080/fulltext/suggest';
reversegeocodingUrl='http://localhost:8080/reversegeocoding/search';
enableReverseGeocoding=true;//todo if enable check reversegeocodingUrl is defined

function buildSearchBox(){
	var box = $('<input>').attr('type','text').attr('placeholder',translation['placeholder'][DEFAULT_LANGUAGE]).attr('id',inputSearchNodeID).attr('name','q').attr('autocomplete','off').addClass('typeahead clearable searchbox').appendTo('#'+formNodeID);
	//<input type="text" placeholder="Enter an address, GPS or DMS coordinate" id="ELEMENT_IDautocomplete" autocomplete="off" class="typeahead clearable"/>
}

function buildPlaceTypeDropBox(lang){
	if (!lang){
	 lang=DEFAULT_LANGUAGE;
	}
	$('#lang'+lang).attr('checked','true');
	lang=lang.toUpperCase(); 
	var dropBoxHtml = $("#"+placetypeNodeID);
	var sel = $('<select>').attr('id',placetypeNodeID).attr('name','placetype').addClass('placetypes');
	if (dropBoxHtml.length > 0){
		dropBoxHtml.replaceWith(sel);
	} else {
		sel.appendTo('#'+formNodeID)
	}

	sel.append($("<option>").attr('value','').text(translation['choosepoitype'][lang]));
	$.each(placetype, function( placetype, value ) {
	//	console.log( index + ": " + value );
		$.each(value, function( countrycode, translations ) {
			if (countrycode == lang ){
				selectOptionText=placetype;
				if(translations.length >=1){
					selectOptionText= translations[0];
				} 
					//console.log( placetype+'['+countrycode+']' + "=" + selectOptionText );
					sel.append($("<option>").attr('value',placetype).text(selectOptionText));
			}
			//var value= index;
	
	});
	});
};

function BuildLanguageSelector(lang){
	$.each(SUPPORTED_LANGUAGE, function( key, value ) {
		$('<input>').attr('type','radio').attr('name','lang').attr('onclick','changeLanguage(this.value);').attr('id','lang'+key).attr('value',key).addClass('languages').appendTo('#'+formNodeID).after(value);
	});
}

function buildPoisArray(lang){
	if (!lang){
	 lang=DEFAULT_LANGUAGE;
	}
	var pois=[];
	var seen = {};
	$.each(placetype, function( placetype, value ) {
			$.each(value, function( countrycode, translations ) {
				if (countrycode == lang ){
					if(translations.length == 0){
						//no translations
						pois.push(placetype);
					} else {
						selectOptionText=placetype;
						if(translations.length > 0) {
							 for (var i = 0, len = translations.length; i < len; i++) {
								if (!seen[translations[i]]) {
								    seen[translations[i]] = true;
								    pois.push(translations[i]);
								}
					    		}
						}
					}
				}
			});
	});
	return pois;
}

function initUI(){
$('<form>').attr('id',formNodeID).appendTo('#'+ELEMENT_ID);
if(allowLanguageSelection){
	BuildLanguageSelector(DEFAULT_LANGUAGE);
}
if(allowPoiSelection){
	buildPlaceTypeDropBox(DEFAULT_LANGUAGE);
}
buildSearchBox();
pois = buildPoisArray(DEFAULT_LANGUAGE);
}

Handlebars.registerHelper('if_eq', function(a, b, opts) {
    if(a == b) 
        return opts.fn(this);
    else
        return opts.inverse(this);
});

Handlebars.registerHelper('l10n', function(keyword) {
	target = translation[keyword][currentLanguage];
	// fallback to the original string if nothing found
	target = target || keyword;	
	//output
	return target;
});



function normalize(input) {
 	    $.each(charMap, function (unnormalizedChar, normalizedChar) {
    	    var regex = new RegExp(unnormalizedChar, 'gi');
    	    input = input.replace(regex, normalizedChar);
	 });
	 return input.replace(/\W+/,'');
}

initUI();

var geocoding = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.nonword('name'),
  queryTokenizer: Bloodhound.tokenizers.nonword,
  limit : 5,
  local: getLocalSuggestionsArray(DEFAULT_LANGUAGE),
  remote:{
		url:fulltextURL +'?suggest=true&allwordsrequired=false&q=%QUERY',
		replace:function () {
			if (enableReverseGeocoding){
				var latLong = convertToLatLong($('#'+inputSearchNodeID).val());
				if (latLong){
					return reversegeocodingUrl +"?format=json&lat="+latLong.lat+"&lng="+latLong.long;
				} 
			}	
			return fulltextURL +'?suggest=true&allwordsrequired=false&'+ $('#'+formNodeID).serialize();
		},
  		filter: function(d,e) {
			var names = [];
			if (d && d.response && d.response['docs']){
				$.each(d.response['docs'], function( key, value ) {
					if(value.name){
						names.push(value);
					}				
				});
			} else if (d && d.result && d.result[0]){
				names.push(convertAddress(d.result[0]));
			}
			return names;
			
		 },
 		rateLimitWait:10
	}
});

geocoding.initialize();

$('#'+inputSearchNodeID).typeahead({
  hint: true,
  highlight: true,
  minLength: 1
},
{
  name: 'geocoding',
  displayKey: function(obj){
				is_in='';
				if (obj['is_in'] || obj['adm1_name'] ){
					if (obj['is_in']){
					is_in=obj['is_in'];
					} else if (obj['adm1_name']){
					is_in=obj['adm1_name'];
					}
					return obj['name']+' , '+is_in;
				} else {
					return obj['name']
				}
				},
  // `ttAdapter` wraps the suggestion engine in an adapter that
  // is compatible with the typeahead jQuery plugin
  source: geocoding.ttAdapter(),
  templates: {
    empty: Handlebars.compile('<div class="empty-message">{{l10n "nosuggestion" currentLanguage}}</div>'),
 /* empty: function(){
		return '<div class="empty-message">translation["nosuggestion"][currentLanguage]</div>';
		//$('geocoding').typeahead('close');
},*/
    suggestion: Handlebars.compile('{{#if name}}<p>{{#if country_code}}<img src="img/{{country_code}}.png" alt={{country_code}} class="flag-autocomplete"/> {{/if}}<strong>{{name}} {{#if_eq zipcode.length 1}}({{zipcode}}){{/if_eq}}</strong>{{#if is_in}} <span class="isin-autocomplete">, {{is_in}}</span> {{else}}{{#if adm1_name}} <span class="isin-autocomplete">, {{adm1_name}}</span>{{/if}}{{/if}}</p>{{/if}}'),
    footer: '<div class="footer">powered by <a href="http://www.gisgraphy.com" target="gisgraphy">Gisgraphy</a></div>'
  }
});

$('#'+inputSearchNodeID).bind('typeahead:selected', function(obj, datum, name) {      
        console.log(obj); 
        console.log(datum);
        console.log(name); 

});

$('#'+inputSearchNodeID).focus();


 function tog(v){return v?'addClass':'removeClass';} 
  
  $(document).on('input', '.clearable', function(){
    $(this)[tog(this.value)]('x');
  }).on('mousemove', '.x', function( e ){
    $(this)[tog(this.offsetWidth-18 < e.clientX-this.getBoundingClientRect().left)]('onX');   
  }).on('click', '.onX', function(){
    $(this).removeClass('x onX').val('');
    $('geocoding').typeahead('val','');
    $('geocoding').typeahead('close');
  });

function getLocalSuggestionsArray(lang){
	poiArray = $.map(pois, function(poi) { return { name: poi+" "+ translation['near'][lang]+" ",country_code:"gps" }; })
	streetArray= $.map(streettype[lang], function(st) { return { name: st,country_code:"road" }; })
	return $.merge(poiArray,streetArray);
}

function changeLanguage(lang){
	currentLanguage=lang;
	buildPlaceTypeDropBox(lang);
	pois = buildPoisArray(lang);
	geocoding.clear();
	geocoding.local= getLocalSuggestionsArray(lang);
	geocoding.initialize(true);
	$('#'+inputSearchNodeID).focus();
	$('#'+inputSearchNodeID).attr('placeholder',translation['placeholder'][lang])
	
}


function convertAddress(address){
	doc= {"name":address.streetName, "is_in":address.city, "country_code":address.countryCode, "lat":address.lat,"lng":address.lng,"distance":address.distance,"houseNumber":address.houseNumber};
	return doc;
}
//-------------------------------------------------------------------------------------------
//DMS

/*
 Pattern 1 (ex: 40:26:46.302N 079:56:55.903W)
 Pattern 2 (ex: 40°26′47″N 079°58′36″W or 40°26'47"N 079°58'36"W)
 Pattern 3 (ex: 40d 26′ 47″ N 079d 58′ 36″ W or 40d 26' 47" N 079d 58' 36" W)
*/

function convertDMS(input){
var obj;
var matches = input.match(/((\d+)\s?[:°dD]*\s?(\d+)\s?\s?[:'′]*\s?(\d+([.]\d+)?)?\s?[:\"″]*\s?([NnSs])\s?([,;]\s?)?(\d+)\s?[:°dD]*\s?(\d+)\s?[:'′]*\s?(\d+([.]\d+)?)?\s?[:\"″]*\s?([EeWw]))/);
if (matches){
	/*for (var i=0;i<matches.length;i++){
		console.log(matches[i]);
	}*/
	lat = convertToDecimal(matches[2],matches[3],matches[4],matches[6]);
	long = convertToDecimal(matches[8],matches[9],matches[10],matches[12]);
	obj =  {"lat":lat,"long":long};
}
return obj
}


function convertToDecimal(
degrees, minutes, seconds, hemisphere){

var hemi = (hemisphere.toUpperCase() === "N"
|| hemisphere.toUpperCase() === "E") ? 1 : -1;

degrees=parseFloat(degrees.replace(',', '.'))
minutes=parseFloat(minutes.replace(',', '.'))
seconds=parseFloat(seconds.replace(',', '.'))

return (degrees + minutes / 60.0 + seconds / 3600.0) * hemi ;
}

function couldbeCoordinate(str){
	match =  str.match(/[-\d\sWwEeNnSsOo\.,:°'"]+/);
	if (match){
		return match[0]==str;
	} else {
		return false;
	}
}



/* Pattern 1 (ex: -23.399437,-52.090904 or 40.446195, -79.948862)
 Pattern 2 (ex: 40.446195N 79.948862W)
*/
function convertDD(input){
	var obj;
	var matches = input.match(/((-?\d+[.,]\d+)\s*([NnSs])?(\s*[,;]?\s*)?(-?\d+[,.]\d+)\s*([WwEe])?)/);
	if (matches){
		/*for (var i=0;i<matches.length;i++){
			console.log(matches[i]);
		}*/
		lat = parseDD(matches[2],matches[3]);
		long = parseDD(matches[5],matches[6]);
		obj =  {"lat":lat,"long":long};
	}
		return obj;
}


function parseDD(decimalDegrees, hemisphere){
	var hemi = 1;
	if(hemisphere){
		 hemi = (hemisphere.toUpperCase() === "N"
		|| hemisphere.toUpperCase() === "E") ? 1 : -1;
	}

	decimalDegrees=parseFloat(decimalDegrees.replace(',', '.'));

return decimalDegrees * hemi ;
}

/*convertDMS("40:26:46.302N 079:56:55.903W");
convertDMS(50°37'59.7"N 3°03'13.2"E")
convertDD("-23.399437,-52.090904");
convertDD("-23.399437 -52.090904");
convertDD("-23,399437  -52,090904");*/

function convertToLatLong(str){
	var obj;	
	if(str){
		if (couldbeCoordinate(str)){
			obj= convertDD(str);
			if(!obj){
				obj = convertDMS(str)
			}
		}	
	}
	return obj;
}



</script>

</body>

</html>